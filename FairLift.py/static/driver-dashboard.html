<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FairLift — Driver Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --accent: #A3001E; }
    body { margin: 0; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 220px; background: var(--accent); color: #fff; display: flex; flex-direction: column; height: 100vh; position: fixed; top: 0; left: 0; padding: 25px 15px; }
    .sidebar h2 { text-align: center; font-size: 20px; font-weight: 700; letter-spacing: 1px; margin-bottom: 25px; }
    .nav-link { color: #fff; display: flex; align-items: center; padding: 12px 14px; border-radius: 8px; margin: 5px 0; font-weight: 500; text-decoration: none; transition: 0.25s; }
    .nav-link i { margin-right: 12px; font-size: 1.1rem; }
    .nav-link:hover { background: rgba(255,255,255,0.12); transform: translateX(3px); }
    .nav-link.active { background: #fff; color: var(--accent); font-weight: 600; }
    .spacer { flex-grow: 1; }
    .logout { background: rgba(255,255,255,0.12); text-align: center; padding: 10px; border-radius: 6px; color: #fff; text-decoration: none; transition: 0.2s; }
    .logout:hover { background: rgba(255,255,255,0.2); }

    .main { margin-left: 220px; display: flex; height: 100vh; width: calc(100% - 220px); }
    #map { flex: 1; width: 100%; height: 100vh; min-height: 500px; background: #ddd; }
    .panel { width: 350px; padding: 18px; background: #fff; border-left: 1px solid #eee; overflow: auto; }
    .btn { background: var(--accent); color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .btn-secondary { background: #555; color: #fff; }
  </style>
</head>
<body>
  <nav class="sidebar">
    <h2>FAIRLIFT</h2>
    <a href="#" class="nav-link active"><i class="bi bi-truck"></i> My Route</a>
    <a href="#" class="nav-link" id="viewParcels"><i class="bi bi-box"></i> My Parcels</a>
    <div class="spacer"></div>
    <a href="/static/Login.html" class="logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
  </nav>

  <div class="main">
    <div id="map"></div>

    <div class="panel">
      <h3>Driver Route</h3>
      <p>View and start your assigned delivery route.</p>

      <div id="parcelCard" style="display:none;margin-top:12px;">
        <h4 id="pn">Tracking: --</h4>
        <div><strong>From:</strong> <span id="fromText">--</span></div>
        <div><strong>To:</strong> <span id="toText">--</span></div>
        <div style="margin-top:8px;"><strong>Status:</strong> <span id="statusText">--</span></div>
      </div>

      <div style="margin-top:12px;">
        <button id="startTrip" class="btn">Start Trip</button>
        <button id="stopTrip" class="btn btn-secondary" style="display:none;">End Trip</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const MAPTILER_KEY = "LYrqvcgKxgR314TOr230";
  const map = L.map('map').setView([14.6042, 120.9822], 11);
  L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`, {
    attribution: '&copy; OpenStreetMap &copy; MapTiler'
  }).addTo(map);

  let routeLayer = null;
  let driverMarker = null;
  let watchId = null;

  async function getCoords(address) {
    const res = await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(address)}.json?key=${MAPTILER_KEY}`);
    const data = await res.json();
    if (!data.features.length) throw new Error("Address not found: " + address);
    return data.features[0].geometry.coordinates;
  }

  async function drawRoute(fromAddress, toAddress) {
    const [fromLng, fromLat] = await getCoords(fromAddress);
    const [toLng, toLat] = await getCoords(toAddress);

    const routeURL = `https://api.maptiler.com/routing/route/v2/driving/${fromLng},${fromLat};${toLng},${toLat}?key=${MAPTILER_KEY}&geometries=geojson`;
    const routeRes = await fetch(routeURL);
    const routeData = await routeRes.json();

    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(routeData.routes[0].geometry, { style: { color: '#A3001E', weight: 5 } }).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    if (driverMarker) map.removeLayer(driverMarker);
    driverMarker = L.marker([fromLat, fromLng]).addTo(map).bindPopup("Start Point");
  }

  async function loadAssignedParcel() {
    const res = await fetch('/api/driver/assigned', { credentials: 'include' });
    const p = await res.json();
    if (!p || p.error) return alert('No assigned parcel found.');

    document.getElementById('parcelCard').style.display = 'block';
    document.getElementById('pn').textContent = 'Tracking: ' + p.tracking_number;
    document.getElementById('fromText').textContent = 'FairLift Warehouse, Las Pinas';
    document.getElementById('toText').textContent = p.destination || '—';
    document.getElementById('statusText').textContent = p.status || '—';

    await drawRoute('Las Pinas', p.destination);
  }

  // GPS simulation: track driver position gradually along route
  document.getElementById('startTrip').addEventListener('click', async ()=>{
    document.getElementById('startTrip').style.display = 'none';
    document.getElementById('stopTrip').style.display = 'inline-block';
    alert("Trip started! Tracking your location...");

    watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      if (driverMarker) driverMarker.setLatLng([latitude, longitude]);
      else driverMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("You");
    }, err=>{
      console.error("GPS error:", err);
      alert("Unable to access GPS");
    });
  });

  document.getElementById('stopTrip').addEventListener('click', ()=>{
    if (watchId) navigator.geolocation.clearWatch(watchId);
    alert("Trip ended.");
    document.getElementById('startTrip').style.display = 'inline-block';
    document.getElementById('stopTrip').style.display = 'none';
  });

  loadAssignedParcel();
  </script>
</body>
</html>
